/*
 * Kernel stack overflow basics
 * https://blog.0x80.org/kernel-stack-overflows-basics/
 */

#include <linux/kernel.h>
#include <linux/module.h>
#include <linux/proc_fs.h>
#include <linux/sched.h>

struct proc_dir_entry *proc_file_entry;

// Buggy write handling
int buggy_write(struct file *file,
        const char *buf,
        unsigned long len) {

    char data[8];

    printk(" buggy_write %sn", buf);
    memcpy(data, buf, len);

    return len;
}

static struct file_operations buggy_proc_fops = {
  .write = buggy_write,
};

int init_module()
{
    printk(" module startedn");
    printk(" creating proc entry @ /proc/buggyn");

    // handle anything written to /proc/buggy
    // pass it to buggy_write
    proc_file_entry = proc_create("buggy", 0666, NULL, &buggy_proc_fops);

    return 0;
}

void cleanup_module()
{
    remove_proc_entry("buggy", NULL);
}
